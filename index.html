<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registro - Emergent Cold</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f8f9fa; padding: 40px; }
        form { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 0 10px rgba(0,0,0,0.2); width: 500px; margin: auto; }
        .parada-group { border: 1px dashed #ced4da; padding: 10px; margin-top: 15px; border-radius: 5px; position: relative; }
        label { font-weight: bold; display: block; margin-top: 15px; }
        select, input, button { width: 100%; padding: 8px; margin-top: 8px; border-radius: 8px; border: 1px solid #170303; box-sizing: border-box; }
        .time-row { display: flex; gap: 10px; }
        .time-display { display: block; font-size: 0.8em; color: #007bff; font-weight: bold; margin-top: 4px; }
        .btn-rojo { background-color: #dc3545; color: white; border: none; cursor: pointer; margin-top: 10px; font-weight: bold; }
        .btn-verde { background-color: #28a745; color: white; border: none; cursor: pointer; margin-top: 10px; }
        button[type="submit"] { background-color: #007bff; color: white; border: none; margin-top: 20px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <h2 style="text-align:center;">FORMULARIO - EMERGENT COLD</h2>

    <form id="formulario-registro" name="registro-emergent-cold" method="POST" data-netlify="true">
        <input type="hidden" name="form-name" value="registro-emergent-cold">

        <label for="lugar">Lugar de operación:</label>
        <select name="lugar" id="lugar" required onchange="actualizarCampos(); guardarProgreso();">
            <option value="">Seleccione una opción</option>
            <option value="Celta">Celta</option>
            <option value="Interpark">Interpark</option>
            <option value="Buga">Buga</option>
            <option value="Giron">Giron</option>
        </select>
        
        <label for="jefe">Jefe Asignado:</label>
        <input type="text" name="jefe" id="jefe" readonly required>
        
        <label for="fecha">Fecha:</label>
        <input type="date" name="fecha" id="fecha" required oninput="guardarProgreso()">

        <label for="turno">Turno Asignado:</label>
        <select name="turno" id="turno" required onchange="guardarProgreso()">
            <option value="">Seleccione un turno</option>
            <option value="Manana">Mañana</option>
            <option value="Tarde">Tarde</option>
            <option value="Noche">Noche</option>
        </select>
        
        <h3 style="text-align:center; color:#d9611b;">REGISTRO DE PARADAS</h3>
        <div id="paradas-contenedor"></div>

        <button type="button" class="btn-verde" onclick="agregarCampoParada(); guardarProgreso();">+ Agregar Parada</button>
        
        <hr>
        <label for="total_personas">Total Personas:</label>
        <input type="number" name="total_personas" id="total_personas" required oninput="guardarProgreso()">

        <button type="submit">Enviar Registro</button>
        <button type="button" class="btn-rojo" onclick="borrarTodo()">BORRAR TODO EL FORMULARIO</button>
    </form>

    <script>
        // --- LOGICA DE PERSISTENCIA ---
        
        function guardarProgreso() {
            const paradas = [];
            document.querySelectorAll('.parada-group').forEach(grupo => {
                paradas.push({
                    inicio: grupo.querySelector('[name="parada_inicio[]"]').value,
                    fin: grupo.querySelector('[name="parada_fin[]"]').value,
                    motivo: grupo.querySelector('[name="motivo[]"]').value,
                    otro: grupo.querySelector('[name="otro_motivo[]"]').value
                });
            });

            const data = {
                lugar: document.getElementById('lugar').value,
                jefe: document.getElementById('jefe').value,
                fecha: document.getElementById('fecha').value,
                turno: document.getElementById('turno').value,
                total_personas: document.getElementById('total_personas').value,
                paradas: paradas
            };
            localStorage.setItem('emergCold_v2', JSON.stringify(data));
        }

        function cargarProgreso() {
            const raw = localStorage.getItem('emergCold_v2');
            if (!raw) {
                agregarCampoParada(); 
                return;
            }
            const data = JSON.parse(raw);

            // Cargar campos básicos
            document.getElementById('lugar').value = data.lugar || "";
            document.getElementById('jefe').value = data.jefe || "";
            document.getElementById('fecha').value = data.fecha || "";
            document.getElementById('turno').value = data.turno || "";
            document.getElementById('total_personas').value = data.total_personas || "";

            // Reconstruir paradas
            if (data.paradas && data.paradas.length > 0) {
                data.paradas.forEach(p => agregarCampoParada(p.inicio, p.fin, p.motivo, p.otro));
            } else {
                agregarCampoParada();
            }
        }

        function borrarTodo() {
            if (confirm("¿Limpiar todo?")) {
                localStorage.removeItem('emergCold_v2');
                window.location.reload();
            }
        }

        // --- FUNCIONES DE FORMULARIO ---

        function agregarCampoParada(valI='', valF='', valM='', valO='') {
            const contenedor = document.getElementById('paradas-contenedor');
            const index = contenedor.children.length + 1;
            const div = document.createElement('div');
            div.className = 'parada-group';
            
            div.innerHTML = `
                <p><b>Parada #${index}</b></p>
                <div class="time-row">
                    <input type="text" name="parada_inicio[]" value="${valI}" placeholder="HH:MM" maxlength="5" oninput="mascaraHora(this); guardarProgreso();">
                    <input type="text" name="parada_fin[]" value="${valF}" placeholder="HH:MM" maxlength="5" oninput="mascaraHora(this); guardarProgreso();">
                </div>
                <select name="motivo[]" onchange="mostrarOtro(this); guardarProgreso();">
                    <option value="">Motivo...</option>
                    <option value="aseo" ${valM=='aseo'?'selected':''}>Aseo</option>
                    <option value="otro" ${valM=='otro'?'selected':''}>Otro</option>
                </select>
                <input type="text" name="otro_motivo[]" value="${valO}" placeholder="Especifique..." style="display:${valM=='otro'?'block':'none'};" oninput="guardarProgreso()">
                <button type="button" class="btn-rojo" style="width:auto; padding:2px 10px;" onclick="this.parentNode.remove(); guardarProgreso();">X</button>
            `;
            contenedor.appendChild(div);
        }

        function mascaraHora(input) {
            let v = input.value.replace(/\D/g,'');
            if (v.length > 2) v = v.substring(0,2) + ":" + v.substring(2,4);
            input.value = v;
        }

        function mostrarOtro(select) {
            const campo = select.nextElementSibling;
            campo.style.display = (select.value === 'otro') ? 'block' : 'none';
        }

        function actualizarCampos() {
            const jefes = {"Celta":"Lorena Diaz","Interpark":"Carolina Rodriguez","Giron":"Jeison Aranda","Buga":"Giovanny Ayala"};
            document.getElementById("jefe").value = jefes[document.getElementById("lugar").value] || "";
        }

        window.onload = cargarProgreso;
    </script>
</body>
</html>
